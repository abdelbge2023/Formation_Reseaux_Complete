<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Calculateur VLSM avec D√©partements Personnalis√©s</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f0f2f5; }
header { background: #4CAF50; color: #fff; padding: 20px; text-align: center; font-size: 24px; font-weight: bold; }
nav { background: #333; color: #fff; padding: 10px; position: sticky; top: 0; display: flex; gap: 15px; flex-wrap: wrap; }
nav button { background: #555; border: none; padding: 8px 12px; color: #fff; cursor: pointer; border-radius: 4px; }
nav button:hover { background: #777; }
section { padding: 20px; }
label { display: inline-block; width: 160px; margin-top: 10px; }
input, textarea, select { margin: 5px; padding: 5px; width: 150px; }
button.action { margin: 5px; padding: 8px 12px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 4px; }
button.action:hover { background: #45a049; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; background: #fff; }
th, td { border: 1px solid #999; padding: 8px; text-align: center; }
th { background: #eee; }
#hostsInputs input { width: 80px; }
#barContainer { margin-top: 30px; width: 100%; height: 50px; background: #ddd; border-radius: 5px; position: relative; }
.barSegment { height: 100%; position: absolute; text-align: center; color: #fff; font-weight: bold; line-height: 50px; border-radius: 5px 0 0 5px; overflow: hidden; cursor: pointer; transition: all 0.2s; }
.barSegment:hover { opacity: 0.8; transform: scaleY(1.1); }
.tooltip { position: absolute; background: #333; color: #fff; padding: 5px 8px; border-radius: 4px; font-size: 12px; display: none; pointer-events: none; z-index: 1000; }
.alert { color: red; font-weight: bold; margin-top: 10px; }
.total { margin-top: 15px; font-weight: bold; font-size: 16px; }
.input-group { margin-bottom: 10px; }
.example { background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 14px; }
.explanation { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #ffc107; }
.explanation h3 { margin-top: 0; color: #856404; }
.explanation-step { margin: 10px 0; padding: 10px; background: #fff; border-radius: 4px; }
.calculation { font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 3px; margin: 5px 0; border: 1px solid #dee2e6; }
.network-diagram { background: white; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.router { background: #4CAF50; color: white; padding: 10px; border-radius: 5px; text-align: center; font-weight: bold; margin: 10px 0; }
.subnet-box { border: 2px solid #2196F3; border-radius: 8px; padding: 15px; margin: 15px 0; background: #f8f9fa; }
.subnet-header { background: #2196F3; color: white; padding: 8px; margin: -15px -15px 15px -15px; border-radius: 6px 6px 0 0; font-weight: bold; }
.device-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 10px 0; }
.device { background: #e9ecef; padding: 8px; border-radius: 5px; text-align: center; border: 1px solid #dee2e6; }
.pc { background: #d4edda; border-color: #c3e6cb; }
.server { background: #f8d7da; border-color: #f5c6cb; }
.printer { background: #fff3cd; border-color: #ffeaa7; }
.camera { background: #d1ecf1; border-color: #bee5eb; }
.visual-bits { display: flex; justify-content: center; margin: 15px 0; }
.bit-group { text-align: center; margin: 0 5px; }
.bit-label { font-size: 12px; margin-bottom: 5px; color: #666; }
.bit-visual { width: 60px; height: 30px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border-radius: 5px; }
.network-bits { background: #2196F3; }
.subnet-bits { background: #4CAF50; }
.host-bits { background: #FF9800; }
.architecture { display: flex; flex-wrap: wrap; gap: 20px; margin: 20px 0; }
.architecture-item { flex: 1; min-width: 300px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.architecture-title { background: #6c757d; color: white; padding: 8px; margin: -15px -15px 15px -15px; border-radius: 7px 7px 0 0; text-align: center; font-weight: bold; }
.department-config { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #17a2b8; }
.config-group { margin-bottom: 15px; }
.config-group label { display: block; width: 100%; margin-bottom: 5px; font-weight: bold; }
.config-group input, .config-group textarea, .config-group select { width: calc(100% - 20px); margin: 5px 0; }
.info-bubble { background: #e7f3ff; border: 1px solid #b8daff; border-radius: 5px; padding: 10px; margin: 10px 0; font-size: 14px; }
.info-bubble h4 { margin: 0 0 5px 0; color: #004085; }
.help-icon { color: #17a2b8; cursor: help; margin-left: 5px; }
.tab-container { margin: 20px 0; }
.tab-buttons { display: flex; border-bottom: 1px solid #ddd; }
.tab-button { padding: 10px 20px; background: #f8f9fa; border: 1px solid #ddd; border-bottom: none; cursor: pointer; margin-right: 5px; border-radius: 5px 5px 0 0; }
.tab-button.active { background: white; border-bottom: 1px solid white; margin-bottom: -1px; }
.tab-content { padding: 20px; background: white; border: 1px solid #ddd; border-top: none; }
</style>
</head>
<body>

<header>Calculateur VLSM avec D√©partements Personnalis√©s</header>

<nav>
  <button onclick="scrollToSection('formSection')">Formulaire</button>
  <button onclick="scrollToSection('scenarioSection')">Sc√©nario</button>
  <button onclick="scrollToSection('experimentSection')">Exp√©rience</button>
  <button onclick="scrollToSection('binarySection')">Vue Binaire</button>
  <button onclick="scrollToSection('resultSection')">R√©sultats</button>
  <button onclick="scrollToSection('graphSection')">Graphique</button>
  <footer>Version Web (El azhari Amazzale Abdelhadi)</footer>
</nav>

<section id="formSection">
<h2>üß™ Configuration du Sc√©nario R√©seau</h2>

<div class="example">
  <strong>Sc√©nario d'entreprise :</strong> Personnalisez vos d√©partements et leurs besoins r√©seau
</div>

<div class="input-group">
  <label>Adresse r√©seau :</label>
  <input type="text" id="network" placeholder="ex: 192.168.0.0">
</div>

<div class="input-group">
  <label>Masque :</label>
  <input type="text" id="mask" placeholder="ex: 255.255.252.0 ou /22">
</div>

<div class="input-group">
  <label>Nombre de d√©partements :</label>
  <input type="number" id="nbSubnets" min="1" max="8">
</div>

<div id="hostsInputs"></div>

<button class="action" onclick="generateHostInputs()">Cr√©er d√©partements</button>
<button class="action" onclick="calculateVLSM()">D√©ployer le r√©seau</button>
<button class="action" onclick="showScenario()">Voir le sc√©nario</button>
<button class="action" onclick="showExperiment()">Mode Exp√©rimental</button>
<button class="action" onclick="exportExcel()">Exporter Excel</button>
<button class="action" onclick="exportPDF()">Exporter PDF</button>
<div id="alertContainer" class="alert"></div>
</section>

<section id="scenarioSection" style="display: none;">
<h2>üè¢ Configuration des D√©partements</h2>
<div id="scenarioContent"></div>
</section>

<section id="experimentSection" style="display: none;">
<h2>üî¨ Mode Exp√©rimental - Architecture R√©seau</h2>
<div id="experimentContent"></div>
</section>

<section id="binarySection" style="display: none;">
<h2>üî¢ Vue Binaire et Calculs</h2>
<div id="binaryExplanations"></div>
</section>

<section id="resultSection">
<h2>üìä Tableau des Sous-r√©seaux</h2>
<div id="result"></div>
<div id="totalHosts" class="total"></div>
</section>

<section id="graphSection">
<h2>üìà Repr√©sentation Graphique</h2>
<div id="barContainer"></div>
<div class="tooltip" id="tooltip"></div>
</section>

<script>
// ------------------ Variables globales ------------------
let lastResult = [];
let calculationSteps = [];
let binaryData = [];
let customDepartments = [];

// ------------------ Navigation ------------------
function scrollToSection(id){
  document.getElementById(id).scrollIntoView({behavior:'smooth'});
}

// ------------------ Mod√®les de d√©partements ------------------
const departmentTemplates = {
  administration: {
    name: "SIEGE - Administration",
    description: "Centre n√©vralgique de l'entreprise avec serveurs et administration",
    devices: [
      { type: "pc", count: 40, name: "Ordinateurs bureau" },
      { type: "server", count: 8, name: "Serveurs" },
      { type: "printer", count: 5, name: "Imprimantes" },
      { type: "camera", count: 12, name: "Cam√©ras s√©curit√©" }
    ],
    color: "#4CAF50"
  },
  production: {
    name: "PRODUCTION - Atelier",
    description: "Zone de production avec machines et postes op√©rationnels",
    devices: [
      { type: "pc", count: 80, name: "Postes production" },
      { type: "printer", count: 8, name: "Imprimantes √©tiquettes" },
      { type: "camera", count: 20, name: "Cam√©ras surveillance" }
    ],
    color: "#2196F3"
  },
  commercial: {
    name: "COMMERCIAL - Ventes",
    description: "√âquipe commerciale et gestion client√®le",
    devices: [
      { type: "pc", count: 25, name: "Postes commerciaux" },
      { type: "printer", count: 3, name: "Imprimantes rapports" },
      { type: "server", count: 2, name: "Serveurs CRM" }
    ],
    color: "#FF9800"
  },
  recherche: {
    name: "R&D - Innovation",
    description: "Laboratoire de recherche et d√©veloppement",
    devices: [
      { type: "pc", count: 15, name: "Postes ing√©nieurs" },
      { type: "server", count: 5, name: "Serveurs d√©veloppement" },
      { type: "printer", count: 2, name: "Imprimantes prototypes" }
    ],
    color: "#9C27B0"
  },
  logistique: {
    name: "LOGISTIQUE - Entrep√¥t",
    description: "Gestion des stocks et exp√©ditions",
    devices: [
      { type: "pc", count: 10, name: "Postes gestion" },
      { type: "printer", count: 4, name: "Imprimantes codes-barres" },
      { type: "camera", count: 15, name: "Cam√©ras entrep√¥t" }
    ],
    color: "#E91E63"
  },
  custom: {
    name: "Personnalis√©",
    description: "D√©partement personnalis√©",
    devices: [
      { type: "pc", count: 20, name: "Ordinateurs" },
      { type: "printer", count: 2, name: "Imprimantes" }
    ],
    color: "#607D8B"
  }
};

// ------------------ Utilitaires Binaires ------------------
function ipToBinary(ip) {
  const parts = ip.split('.').map(Number);
  return parts.map(part => part.toString(2).padStart(8, '0')).join('');
}

function binaryToIp(binary) {
  const octets = [];
  for (let i = 0; i < 32; i += 8) {
    octets.push(parseInt(binary.substr(i, 8), 2));
  }
  return octets.join('.');
}

function maskToBinary(prefix) {
  let binary = '';
  for (let i = 0; i < 32; i++) {
    binary += i < prefix ? '1' : '0';
  }
  return binary;
}

// ------------------ Utilitaires ------------------
function maskToPrefix(mask) {
  if (!mask) return null;
  
  if (mask.startsWith("/")) {
    const prefix = parseInt(mask.slice(1));
    return (prefix >= 0 && prefix <= 32) ? prefix : null;
  }
  
  const parts = mask.split(".").map(Number);
  if (parts.length !== 4 || parts.some(p => isNaN(p) || p < 0 || p > 255)) {
    return null;
  }
  
  const binary = parts.map(p => p.toString(2).padStart(8, "0")).join("");
  const firstZero = binary.indexOf("0");
  if (firstZero === -1) return 32;
  
  if (binary.indexOf("1", firstZero) !== -1) {
    return null;
  }
  
  return firstZero;
}

function ipToInt(ip) {
  if (!ip) return null;
  const parts = ip.split(".").map(Number);
  if (parts.length !== 4 || parts.some(p => isNaN(p) || p < 0 || p > 255)) {
    return null;
  }
  return parts.reduce((a, b) => a * 256 + b, 0);
}

function intToIp(int) {
  return [(int >> 24) & 255, (int >> 16) & 255, (int >> 8) & 255, int & 255].join(".");
}

function isValidIP(ip) {
  const regex = /^(\d{1,3}\.){3}\d{1,3}$/;
  if (!regex.test(ip)) return false;
  const parts = ip.split(".").map(Number);
  return parts.every(p => p >= 0 && p <= 255);
}

function getDeviceIcon(type) {
  const icons = {
    pc: "üíª",
    server: "üñ•Ô∏è",
    printer: "üñ®Ô∏è",
    camera: "üìπ",
    phone: "üì±",
    switch: "üîÄ",
    router: "üîÑ"
  };
  return icons[type] || "üì±";
}

// ------------------ G√©n√©rer champs d√©partements ------------------
function generateHostInputs() {
  const nb = parseInt(document.getElementById("nbSubnets").value);
  if (isNaN(nb) || nb < 1) {
    alert("Veuillez entrer un nombre valide de d√©partements");
    return;
  }
  
  // R√©initialiser les d√©partements personnalis√©s
  customDepartments = [];
  const templateKeys = Object.keys(departmentTemplates);
  
  const div = document.getElementById("hostsInputs");
  div.innerHTML = "";
  
  for (let i = 0; i < nb; i++) {
    const template = departmentTemplates[templateKeys[i % templateKeys.length]];
    customDepartments.push({...template});
    
    div.innerHTML += `
      <div class="input-group">
        <label>D√©partement ${i+1}:</label>
        <input type="number" id="hosts${i}" min="1" value="${template.devices.reduce((sum, d) => sum + d.count, 0)}">
        <small style="color: #666;">${template.description}</small>
      </div>
    `;
  }
  
  // Afficher imm√©diatement la configuration
  showScenario();
}

// ------------------ Afficher la configuration des d√©partements ------------------
function showScenario() {
  const nb = parseInt(document.getElementById("nbSubnets").value);
  if (isNaN(nb) || nb < 1) {
    alert("Configurez d'abord le nombre de d√©partements !");
    return;
  }
  
  let html = `
    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-button active" onclick="showTab('configTab')">Configuration</button>
        <button class="tab-button" onclick="showTab('infoTab')">Informations VLSM</button>
        <button class="tab-button" onclick="showTab('bestPracticesTab')">Bonnes Pratiques</button>
      </div>
      
      <div class="tab-content">
        <div id="configTab" class="tab-panel active">
          <h3>üõ†Ô∏è Configuration des D√©partements</h3>
          <p>Personnalisez chaque d√©partement selon vos besoins :</p>
  `;
  
  for (let i = 0; i < nb; i++) {
    const dept = customDepartments[i] || departmentTemplates.administration;
    html += `
      <div class="department-config">
        <div class="config-group">
          <label>Nom du D√©partement ${i+1} <span class="help-icon" title="Choisissez un nom significatif pour identifier facilement ce d√©partement">‚ÑπÔ∏è</span></label>
          <input type="text" id="deptName${i}" value="${dept.name}" onchange="updateDepartment(${i}, 'name', this.value)">
        </div>
        
        <div class="config-group">
          <label>Description <span class="help-icon" title="D√©crivez l'usage et les besoins sp√©cifiques de ce d√©partement">‚ÑπÔ∏è</span></label>
          <textarea id="deptDesc${i}" rows="2" onchange="updateDepartment(${i}, 'description', this.value)">${dept.description}</textarea>
        </div>
        
        <div class="config-group">
          <label>Mod√®le de D√©partement <span class="help-icon" title="S√©lectionnez un mod√®le pr√©d√©fini ou personnalisez">‚ÑπÔ∏è</span></label>
          <select id="deptTemplate${i}" onchange="applyTemplate(${i}, this.value)">
            <option value="custom">Personnalis√©</option>
            <option value="administration">Administration</option>
            <option value="production">Production</option>
            <option value="commercial">Commercial</option>
            <option value="recherche">Recherche & D√©veloppement</option>
            <option value="logistique">Logistique</option>
          </select>
        </div>
        
        <div class="config-group">
          <label>Nombre d'Appareils <span class="help-icon" title="Estimez le nombre total d'appareils connect√©s (PC, serveurs, imprimantes, etc.)">‚ÑπÔ∏è</span></label>
          <input type="number" id="deptHosts${i}" min="1" value="${dept.devices.reduce((sum, d) => sum + d.count, 0)}" onchange="updateDepartmentHosts(${i}, this.value)">
        </div>
        
        <div class="config-group">
          <label>D√©tail des Appareils <span class="help-icon" title="R√©partition d√©taill√©e des diff√©rents types d'appareils">‚ÑπÔ∏è</span></label>
          <div class="device-grid">
    `;
    
    dept.devices.forEach((device, deviceIndex) => {
      html += `
        <div class="device ${device.type}">
          <div>${getDeviceIcon(device.type)}</div>
          <div><strong>${device.count}x</strong></div>
          <div style="font-size: 12px;">${device.name}</div>
          <input type="number" style="width: 50px; font-size: 12px; margin-top: 5px;" 
                 value="${device.count}" 
                 onchange="updateDeviceCount(${i}, ${deviceIndex}, this.value)">
        </div>
      `;
    });
    
    html += `
          </div>
        </div>
        
        <div class="info-bubble">
          <h4>üí° Conseil de Planification</h4>
          <p>Pr√©voyez <strong>20% d'appareils suppl√©mentaires</strong> pour les futures expansions. 
          Les besoins r√©seau √©voluent souvent plus vite que pr√©vu !</p>
        </div>
      </div>
    `;
  }
  
  html += `
        </div>
        
        <div id="infoTab" class="tab-panel" style="display: none;">
          <h3>üìö Comprendre le VLSM</h3>
          <div class="info-bubble">
            <h4>üéØ Qu'est-ce que le VLSM ?</h4>
            <p>Le <strong>Variable Length Subnet Mask</strong> (Masque de Sous-R√©seau √† Longueur Variable) permet de cr√©er des sous-r√©seaux de tailles diff√©rentes au sein d'un m√™me r√©seau principal.</p>
          </div>
          
          <div class="info-bubble">
            <h4>üí∞ Avantages du VLSM</h4>
            <ul>
              <li><strong>√âconomie d'adresses IP</strong> : Pas de gaspillage</li>
              <li><strong>Flexibilit√©</strong> : Adapt√© √† chaque besoin</li>
              <li><strong>Optimisation</strong> : Meilleure utilisation de l'espace d'adressage</li>
              <li><strong>Scalabilit√©</strong> : Facilite l'expansion future</li>
            </ul>
          </div>
          
          <div class="info-bubble">
            <h4>üîß Cas d'Usage Typiques</h4>
            <p><strong>Administration</strong> : Serveurs + postes fixes ‚Üí Grand sous-r√©seau<br>
            <strong>Production</strong> : Machines + capteurs ‚Üí Sous-r√©seau moyen<br>
            <strong>Direction</strong> : Quelques postes ‚Üí Petit sous-r√©seau<br>
            <strong>R√©seau invit√©</strong> : Acc√®s limit√© ‚Üí Tr√®s petit sous-r√©seau</p>
          </div>
        </div>
        
        <div id="bestPracticesTab" class="tab-panel" style="display: none;">
          <h3>üèÜ Bonnes Pratiques R√©seau</h3>
          <div class="info-bubble">
            <h4>üìè Planification d'Adressage</h4>
            <ul>
              <li>Commencez par les plus grands sous-r√©seaux</li>
              <li>R√©servez des plages pour les futures expansions</li>
              <li>Utilisez une convention de nommage coh√©rente</li>
              <li>Documentez votre plan d'adressage</li>
            </ul>
          </div>
          
          <div class="info-bubble">
            <h4>üõ°Ô∏è S√©curit√© et Organisation</h4>
            <ul>
              <li>Isolez les r√©seaux sensibles (serveurs, administration)</li>
              <li>Cr√©ez un r√©seau d√©di√© pour les invit√©s</li>
              <li>S√©parez les r√©seaux voix/donn√©es/vid√©o si n√©cessaire</li>
              <li>Pr√©voyez des VLANs pour la segmentation logique</li>
            </ul>
          </div>
          
          <div class="info-bubble">
            <h4>üìà Gestion de la Croissance</h4>
            <ul>
              <li>Allouez 20-30% d'adresses suppl√©mentaires par sous-r√©seau</li>
              <li>Conservez une plage d'adresses pour les √©quipements r√©seau</li>
              <li>Planifiez l'ajout de nouveaux sites/b√¢timents</li>
              <li>Mettez √† jour r√©guli√®rement la documentation</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <div style="text-align: center; margin-top: 20px;">
      <button class="action" onclick="calculateVLSM()">üíæ Appliquer la Configuration et Calculer le VLSM</button>
    </div>
  `;
  
  document.getElementById('scenarioContent').innerHTML = html;
  document.getElementById('scenarioSection').style.display = 'block';
  scrollToSection('scenarioSection');
}

// ------------------ Gestion des onglets ------------------
function showTab(tabName) {
  // Masquer tous les onglets
  document.querySelectorAll('.tab-panel').forEach(tab => {
    tab.style.display = 'none';
  });
  
  // D√©sactiver tous les boutons
  document.querySelectorAll('.tab-button').forEach(button => {
    button.classList.remove('active');
  });
  
  // Afficher l'onglet s√©lectionn√©
  document.getElementById(tabName).style.display = 'block';
  
  // Activer le bouton correspondant
  event.target.classList.add('active');
}

// ------------------ Mise √† jour des d√©partements ------------------
function updateDepartment(index, field, value) {
  if (!customDepartments[index]) return;
  customDepartments[index][field] = value;
  
  // Mettre √† jour l'input correspondant
  const hostsInput = document.getElementById(`hosts${index}`);
  if (hostsInput && field === 'name') {
    // Mettre √† jour le label ou autre √©l√©ment si n√©cessaire
  }
}

function updateDepartmentHosts(index, value) {
  if (!customDepartments[index]) return;
  
  // Mettre √† jour le total des appareils
  const totalDevices = customDepartments[index].devices.reduce((sum, d) => sum + d.count, 0);
  const scaleFactor = value / totalDevices;
  
  // Ajuster proportionnellement tous les appareils
  customDepartments[index].devices.forEach(device => {
    device.count = Math.max(1, Math.round(device.count * scaleFactor));
  });
  
  // Rafra√Æchir l'affichage
  showScenario();
}

function updateDeviceCount(deptIndex, deviceIndex, value) {
  if (!customDepartments[deptIndex] || !customDepartments[deptIndex].devices[deviceIndex]) return;
  
  customDepartments[deptIndex].devices[deviceIndex].count = parseInt(value) || 1;
  
  // Mettre √† jour le total
  const totalHosts = customDepartments[deptIndex].devices.reduce((sum, d) => sum + d.count, 0);
  document.getElementById(`deptHosts${deptIndex}`).value = totalHosts;
  document.getElementById(`hosts${deptIndex}`).value = totalHosts;
}

function applyTemplate(deptIndex, templateKey) {
  if (!departmentTemplates[templateKey]) return;
  
  customDepartments[deptIndex] = {...departmentTemplates[templateKey]};
  
  // Mettre √† jour l'input des h√¥tes
  const totalHosts = customDepartments[deptIndex].devices.reduce((sum, d) => sum + d.count, 0);
  document.getElementById(`hosts${deptIndex}`).value = totalHosts;
  
  // Rafra√Æchir l'affichage
  showScenario();
}

// ------------------ Mode Exp√©rimental ------------------
function showExperiment() {
  if (lastResult.length === 0) {
    alert("Calculez d'abord le plan VLSM !");
    return;
  }
  
  let html = `
    <div class="architecture">
      <div class="architecture-item">
        <div class="architecture-title">üåê Avant VLSM</div>
        <h4>Probl√®mes avec le sous-r√©seautage classique :</h4>
        <ul>
          <li>üìè Taille fixe pour tous les sous-r√©seaux</li>
          <li>üóëÔ∏è Gaspillage d'adresses IP</li>
          <li>‚ö° Difficult√© d'expansion</li>
          <li>üí∞ Co√ªt √©lev√© en ressources</li>
        </ul>
        <div class="visual-bits">
          <div class="bit-group">
            <div class="bit-label">R√©seau</div>
            <div class="bit-visual network-bits">22 bits</div>
          </div>
          <div class="bit-group">
            <div class="bit-label">H√¥te</div>
            <div class="bit-visual host-bits">10 bits</div>
          </div>
        </div>
        <p><em>Taille fixe: 1024 adresses/d√©partement</em></p>
      </div>
      
      <div class="architecture-item">
        <div class="architecture-title">üöÄ Apr√®s VLSM</div>
        <h4>Avantages du VLSM :</h4>
        <ul>
          <li>üéØ Taille adapt√©e √† chaque besoin</li>
          <li>üí° Optimisation des adresses IP</li>
          <li>üìà Scalabilit√© am√©lior√©e</li>
          <li>üí∞ R√©duction des co√ªts</li>
        </ul>
        <div class="visual-bits">
          <div class="bit-group">
            <div class="bit-label">R√©seau</div>
            <div class="bit-visual network-bits">22 bits</div>
          </div>
          <div class="bit-group">
            <div class="bit-label">Sous-r√©seau</div>
            <div class="bit-visual subnet-bits">Variable</div>
          </div>
          <div class="bit-group">
            <div class="bit-label">H√¥te</div>
            <div class="bit-visual host-bits">Variable</div>
          </div>
        </div>
        <p><em>Taille adaptative selon les besoins</em></p>
      </div>
    </div>
    
    <div class="network-diagram">
      <h3>üîß Impl√©mentation Pratique</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
  `;
  
  lastResult.forEach((subnet, index) => {
    const dept = customDepartments[index] || departmentTemplates.administration;
    html += `
      <div class="subnet-box">
        <div class="subnet-header">${dept.name}</div>
        <div style="text-align: center; margin: 10px 0;">
          <div style="font-size: 24px;">${getDeviceIcon('pc')}${subnet.H√¥tes}</div>
          <div style="font-size: 12px; color: #666;">h√¥tes disponibles</div>
        </div>
        <div class="calculation">
          <strong>R√©seau:</strong> ${subnet.R√©seau}${subnet.Pr√©fixe}<br>
          <strong>Plage utilisable:</strong><br>${subnet.Premi√®re_IP} - ${subnet.Derni√®re_IP}<br>
          <strong>Gateway:</strong> ${subnet.Premi√®re_IP}<br>
          <strong>Broadcast:</strong> ${subnet.Broadcast}
        </div>
        <div style="margin-top: 10px; padding: 8px; background: #e7f3ff; border-radius: 5px;">
          <strong>Configuration routeur:</strong><br>
          <code>interface vlan${index + 10}<br>
          ip address ${subnet.Premi√®re_IP} ${subnet.Pr√©fixe.replace('/', '')}</code>
        </div>
      </div>
    `;
  });
  
  html += `
      </div>
      
      <div style="margin-top: 20px; padding: 15px; background: #d4edda; border-radius: 8px;">
        <h4>‚úÖ Bilan d'Efficacit√©</h4>
        <p><strong>√âconomie d'adresses :</strong> ${calculateAddressSavings()} adresses sauvegard√©es</p>
        <p><strong>Taux d'utilisation :</strong> ${calculateUtilizationRate()}% d'efficacit√©</p>
        <p><strong>Scalabilit√© :</strong> ${lastResult.length} d√©partements optimis√©s</p>
      </div>
    </div>
  `;
  
  document.getElementById('experimentContent').innerHTML = html;
  document.getElementById('experimentSection').style.display = 'block';
  scrollToSection('experimentSection');
}

function calculateAddressSavings() {
  const totalRequired = lastResult.reduce((sum, r) => sum + r.size, 0);
  const totalAllocated = lastResult.reduce((sum, r) => sum + r.H√¥tes, 0);
  return Math.max(0, totalAllocated - totalRequired);
}

function calculateUtilizationRate() {
  const totalRequired = lastResult.reduce((sum, r) => sum + r.size, 0);
  const totalAllocated = lastResult.reduce((sum, r) => sum + r.H√¥tes, 0);
  return totalAllocated > 0 ? Math.round((totalRequired / totalAllocated) * 100) : 0;
}

// ------------------ Calcul VLSM ------------------
function calculateVLSM() {
  const network = document.getElementById("network").value.trim();
  const mask = document.getElementById("mask").value.trim();
  const nb = parseInt(document.getElementById("nbSubnets").value);
  const alertDiv = document.getElementById("alertContainer");
  alertDiv.innerHTML = "";
  calculationSteps = [];
  binaryData = [];
  
  // Validation des entr√©es
  if (!network || !mask || isNaN(nb) || nb < 1) {
    alert("Remplissez tous les champs correctement");
    return;
  }
  
  if (!isValidIP(network)) {
    alert("Adresse r√©seau invalide");
    return;
  }
  
  const prefix = maskToPrefix(mask);
  if (prefix === null) {
    alert("Masque invalide");
    return;
  }
  
  const networkInt = ipToInt(network);
  if (networkInt === null) {
    alert("Adresse r√©seau invalide");
    return;
  }
  
  // R√©cup√©ration des nombres d'h√¥tes depuis les d√©partements personnalis√©s
  const hosts = [];
  for (let i = 0; i < nb; i++) {
    const hostInput = document.getElementById(`hosts${i}`);
    if (!hostInput) {
      alert("G√©n√©rez d'abord les champs pour les d√©partements");
      return;
    }
    
    const h = parseInt(hostInput.value);
    if (isNaN(h) || h < 1) {
      alert(`Veuillez entrer un nombre valide d'appareils pour le d√©partement ${i+1}`);
      return;
    }
    hosts.push({hosts: h, index: i});
  }
  
  // Donn√©es binaires
  binaryData.push({
    type: 'main',
    network: network,
    mask: prefix,
    binaryNetwork: ipToBinary(network),
    binaryMask: maskToBinary(prefix)
  });

  // Tri d√©croissant pour l'allocation VLSM
  hosts.sort((a, b) => b.hosts - a.hosts);
  
  // Calcul des sous-r√©seaux
  lastResult = [];
  let resultHtml = "<table><tr><th>D√©partement</th><th>R√©seau</th><th>Masque</th><th>Appareils max</th><th>Premi√®re IP</th><th>Derni√®re IP</th><th>Broadcast</th></tr>";
  let currentAddress = networkInt;
  let totalHosts = 0;
  const colors = ["#4CAF50", "#2196F3", "#FF9800", "#9C27B0", "#E91E63", "#00BCD4", "#FF5722", "#8BC34A"];
  
  const totalNetworkSize = Math.pow(2, 32 - prefix);
  const networkEnd = networkInt + totalNetworkSize - 1;
  
  let hasOverflow = false;
  
  for (let i = 0; i < hosts.length; i++) {
    const neededHosts = hosts[i].hosts;
    const originalIndex = hosts[i].index;
    const dept = customDepartments[originalIndex] || departmentTemplates.administration;
    
    // Calcul du nouveau pr√©fixe
    const neededAddresses = neededHosts + 2;
    const newPrefix = 32 - Math.ceil(Math.log2(neededAddresses));
    const subnetSize = Math.pow(2, 32 - newPrefix);
    const subnetBits = newPrefix - prefix;
    
    // V√©rifier la capacit√©
    if (currentAddress + subnetSize > networkEnd + 1) {
      alertDiv.innerHTML = "‚ö†Ô∏è Attention : Le r√©seau principal est trop petit !";
      hasOverflow = true;
      break;
    }
    
    // Calcul des adresses
    const networkAddr = currentAddress;
    const firstUsable = networkAddr + 1;
    const lastUsable = networkAddr + subnetSize - 2;
    const broadcastAddr = networkAddr + subnetSize - 1;
    
    totalHosts += neededHosts;
    
    // Stocker les donn√©es binaires
    binaryData.push({
      type: 'subnet',
      sr: originalIndex + 1,
      name: dept.name,
      network: intToIp(networkAddr),
      mask: newPrefix,
      binaryNetwork: ipToBinary(intToIp(networkAddr)),
      binaryMask: maskToBinary(newPrefix),
      subnetBits: subnetBits,
      hostBits: 32 - newPrefix
    });
    
    // Stocker le r√©sultat
    lastResult.push({
      SR: originalIndex + 1,
      Name: dept.name,
      R√©seau: intToIp(networkAddr),
      Pr√©fixe: `/${newPrefix}`,
      H√¥tes: subnetSize - 2,
      Premi√®re_IP: intToIp(firstUsable),
      Derni√®re_IP: intToIp(lastUsable),
      Broadcast: intToIp(broadcastAddr),
      color: dept.color || colors[originalIndex % colors.length],
      size: neededHosts,
      subnetSize: subnetSize
    });
    
    currentAddress += subnetSize;
  }
  
  // Trier les r√©sultats
  lastResult.sort((a, b) => a.SR - b.SR);
  
  // G√©n√©rer le tableau HTML
  lastResult.forEach(r => {
    resultHtml += `<tr style="background:${r.color}20;">
      <td><strong>${r.Name}</strong></td>
      <td>${r.R√©seau}</td>
      <td>${r.Pr√©fixe}</td>
      <td>${r.H√¥tes}</td>
      <td>${r.Premi√®re_IP}</td>
      <td>${r.Derni√®re_IP}</td>
      <td>${r.Broadcast}</td>
    </tr>`;
  });
  
  resultHtml += "</table>";
  document.getElementById("result").innerHTML = resultHtml;
  document.getElementById("totalHosts").innerHTML = `<b>Total appareils demand√©s :</b> ${totalHosts}`;
  
  // Afficher la vue binaire
  displayBinaryView();
  
  if (!hasOverflow) {
    drawBarGraph();
  }
}

// ------------------ Afficher la vue binaire ------------------
function displayBinaryView() {
  const container = document.getElementById("binaryExplanations");
  let html = '';
  
  // R√©seau principal
  const main = binaryData.find(d => d.type === 'main');
  html += `
    <div class="explanation-step">
      <h3>üî¢ Fondamentaux Binaires</h3>
      <div class="calculation">
        <strong>R√©seau Principal :</strong> ${main.network}/${main.mask}<br>
        <strong>Bits r√©seau :</strong> ${main.mask} bits<br>
        <strong>Bits h√¥te :</strong> ${32 - main.mask} bits<br>
        <strong>Adresses totales :</strong> 2<sup>${32 - main.mask}</sup> = ${Math.pow(2, 32 - main.mask)}<br>
        <strong>Adresses utilisables :</strong> ${Math.pow(2, 32 - main.mask) - 2}
      </div>
    </div>
  `;
  
  // Sous-r√©seaux
  const subnets = binaryData.filter(d => d.type === 'subnet');
  html += `<div class="explanation-step">
    <h3>üéØ R√©partition VLSM</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">`;
  
  subnets.forEach(subnet => {
    html += `
      <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #4CAF50;">
        <h4>${subnet.name}</h4>
        <div class="calculation">
          <strong>Masque :</strong> /${subnet.mask}<br>
          <strong>Bits sous-r√©seau :</strong> ${subnet.subnetBits}<br>
          <strong>Bits h√¥te :</strong> ${subnet.hostBits}<br>
          <strong>Taille :</strong> 2<sup>${subnet.hostBits}</sup> = ${Math.pow(2, subnet.hostBits)} adresses<br>
          <strong>Utilisables :</strong> ${Math.pow(2, subnet.hostBits) - 2}
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: #666;">
          <code>${subnet.binaryNetwork.match(/.{1,8}/g).join('.')}</code>
        </div>
      </div>
    `;
  });
  
  html += `</div></div>`;
  
  container.innerHTML = html;
  document.getElementById('binarySection').style.display = 'block';
}

// ------------------ Barre graphique interactive ------------------
function drawBarGraph() {
  const container = document.getElementById("barContainer");
  container.innerHTML = "";
  
  if (lastResult.length === 0) return;
  
  const totalSize = lastResult.reduce((sum, r) => sum + r.subnetSize, 0);
  let offset = 0;
  const tooltip = document.getElementById("tooltip");
  
  lastResult.forEach(r => {
    const widthPercent = (r.subnetSize / totalSize) * 100;
    const div = document.createElement("div");
    div.className = "barSegment";
    div.style.left = offset + "%";
    div.style.width = widthPercent + "%";
    div.style.background = r.color;
    div.innerHTML = r.Name.split(' - ')[0];
    
    div.addEventListener("mousemove", e => {
      tooltip.style.display = "block";
      tooltip.style.left = e.pageX + 10 + "px";
      tooltip.style.top = e.pageY + 10 + "px";
      tooltip.innerHTML = `
        <strong>${r.Name}</strong><br>
        R√©seau: ${r.R√©seau}<br>
        Masque: ${r.Pr√©fixe}<br>
        Appareils max: ${r.H√¥tes}<br>
        Premi√®re IP: ${r.Premi√®re_IP}<br>
        Derni√®re IP: ${r.Derni√®re_IP}
      `;
    });
    
    div.addEventListener("mouseleave", () => {
      tooltip.style.display = "none";
    });
    
    container.appendChild(div);
    offset += widthPercent;
  });
}

// ------------------ Export Excel ------------------
function exportExcel() {
  if (lastResult.length === 0) {
    alert("Calculez d'abord les sous-r√©seaux !");
    return;
  }
  
  const wb = XLSX.utils.book_new();
  
  // Feuille des sous-r√©seaux
  const headers = ["D√©partement", "R√©seau", "Masque", "Appareils max", "Premi√®re IP", "Derni√®re IP", "Broadcast"];
  const ws_data = [headers];
  
  lastResult.forEach(r => {
    ws_data.push([
      r.Name,
      r.R√©seau,
      r.Pr√©fixe,
      r.H√¥tes,
      r.Premi√®re_IP,
      r.Derni√®re_IP,
      r.Broadcast
    ]);
  });
  
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "Plan_R√©seau");
  
  // Feuille de configuration
  const configHeaders = ["D√©partement", "Description", "Appareils demand√©s", "Appareils allou√©s"];
  const configData = [configHeaders];
  
  lastResult.forEach(r => {
    const dept = customDepartments[r.SR - 1];
    configData.push([
      r.Name,
      dept?.description || "",
      r.size,
      r.H√¥tes
    ]);
  });
  
  const wsConfig = XLSX.utils.aoa_to_sheet(configData);
  XLSX.utils.book_append_sheet(wb, wsConfig, "Configuration");
  
  XLSX.writeFile(wb, "Plan_Reseau_Entreprise.xlsx");
}

// ------------------ Export PDF ------------------
function exportPDF() {
  if (lastResult.length === 0) {
    alert("Calculez d'abord les sous-r√©seaux !");
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // En-t√™te
  doc.setFontSize(16);
  doc.text("Plan de R√©seau d'Entreprise - VLSM", 10, 15);
  doc.setFontSize(12);
  
  let y = 30;
  
  // Informations g√©n√©rales
  doc.text("Configuration VLSM - " + new Date().toLocaleDateString(), 10, y);
  y += 10;
  
  // Sous-r√©seaux
  lastResult.forEach(r => {
    if (y > 270) {
      doc.addPage();
      y = 20;
    }
    
    doc.setFont(undefined, 'bold');
    doc.text(`${r.Name}:`, 10, y);
    doc.setFont(undefined, 'normal');
    y += 7;
    
    doc.text(`  R√©seau: ${r.R√©seau}${r.Pr√©fixe}`, 15, y);
    y += 5;
    doc.text(`  Appareils: ${r.H√¥tes} maximum (${r.size} demand√©s)`, 15, y);
    y += 5;
    doc.text(`  Plage IP: ${r.Premi√®re_IP} - ${r.Derni√®re_IP}`, 15, y);
    y += 5;
    doc.text(`  Gateway: ${r.Premi√®re_IP}`, 15, y);
    y += 5;
    doc.text(`  Broadcast: ${r.Broadcast}`, 15, y);
    y += 10;
  });
  
  // Statistiques
  if (y > 250) {
    doc.addPage();
    y = 20;
  }
  
  doc.setFont(undefined, 'bold');
  doc.text("Statistiques:", 10, y);
  doc.setFont(undefined, 'normal');
  y += 10;
  
  doc.text(`  Total appareils demand√©s: ${lastResult.reduce((sum, r) => sum + r.size, 0)}`, 15, y);
  y += 5;
  doc.text(`  Total appareils allou√©s: ${lastResult.reduce((sum, r) => sum + r.H√¥tes, 0)}`, 15, y);
  y += 5;
  doc.text(`  Taux d'utilisation: ${calculateUtilizationRate()}%`, 15, y);
  y += 5;
  doc.text(`  √âconomie d'adresses: ${calculateAddressSavings()}`, 15, y);
  
  doc.save("Plan_Reseau_Entreprise.pdf");
}

// Charger un exemple au d√©marrage
window.onload = function() {
  document.getElementById("network").value = "192.168.0.0";
  document.getElementById("mask").value = "/22";
  document.getElementById("nbSubnets").value = "4";
  generateHostInputs();
}
</script>
</body>
</html>

