<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur VLSM - Explications Binaires D√©taill√©es</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #2E7D32;
            --secondary: #1565C0;
            --accent: #FF6D00;
            --warning: #D32F2F;
            --success: #388E3C;
            --info: #0277BD;
            --dark: #263238;
            --light: #F5F5F5;
            --border: #BDBDBD;
            --network-bit: #2E7D32;
            --subnet-bit: #1565C0;
            --host-bit: #FF6D00;
            --bit-1: #4CAF50;
            --bit-0: #E0E0E0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary) 0%, #1B5E20 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 50%);
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            position: relative;
        }

        header p {
            font-size: 1.2rem;
            opacity: 0.9;
            position: relative;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 5px;
        }

        .nav-tab {
            flex: 1;
            min-width: 150px;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--dark);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .nav-tab:hover {
            background: var(--light);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
        }

        .tab-content {
            display: none;
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            animation: fadeIn 0.5s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-group input, .input-group select {
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1B5E20;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 125, 50, 0.3);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #0D47A1;
            transform: translateY(-2px);
        }

        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin: 2rem 0;
        }

        /* Styles pour les explications binaires */
        .binary-explanation {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin: 2rem 0;
        }

        .binary-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .binary-visualization {
            background: rgba(255,255,255,0.1);
            padding: 1.5rem;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .ip-address-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .ip-octet {
            text-align: center;
            padding: 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .octet-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .octet-binary {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        .bits-container {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            justify-content: center;
            margin: 1.5rem 0;
            padding: 1rem;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }

        .bit-group {
            display: flex;
            gap: 2px;
            margin: 0 5px;
        }

        .bit {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.8rem;
            position: relative;
            transition: all 0.3s ease;
            cursor: help;
        }

        .bit:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        .bit-network {
            background: var(--network-bit);
            color: white;
        }

        .bit-subnet {
            background: var(--subnet-bit);
            color: white;
        }

        .bit-host {
            background: var(--host-bit);
            color: white;
        }

        .bit-1 {
            background: var(--bit-1);
            color: white;
        }

        .bit-0 {
            background: var(--bit-0);
            color: #666;
        }

        .bit-separator {
            width: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.5);
            font-weight: bold;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin: 1rem 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .calculation-steps {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid var(--primary);
        }

        .calculation-step {
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--light);
            border-radius: 8px;
            border-left: 4px solid var(--info);
        }

        .step-title {
            font-weight: bold;
            color: var(--dark);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .step-content {
            font-family: 'Courier New', monospace;
            background: white;
            padding: 1rem;
            border-radius: 5px;
            margin: 0.5rem 0;
            border: 1px solid var(--border);
        }

        .subnet-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .subnet-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-top: 4px solid var(--primary);
            transition: transform 0.3s ease;
        }

        .subnet-card:hover {
            transform: translateY(-5px);
        }

        .subnet-card h4 {
            color: var(--dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-container {
            background: var(--border);
            border-radius: 10px;
            height: 20px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--network-bit), var(--subnet-bit), var(--host-bit));
            transition: width 0.5s ease;
        }

        .table-responsive {
            overflow-x: auto;
            margin: 1.5rem 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--light);
            font-weight: 600;
            color: var(--dark);
        }

        tr:hover {
            background: #f8f9fa;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-top: 4px solid var(--primary);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            display: block;
        }

        .stat-label {
            color: var(--dark);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 250px;
            background: var(--dark);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 0.5rem;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
            font-weight: normal;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üî¢ Calculateur VLSM avec Explications Binaires</h1>
            <p>Comprenez le sous-r√©seautage √† masque variable au niveau binaire avec des visualisations color√©es</p>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('config')">
                ‚öôÔ∏è Configuration
            </button>
            <button class="nav-tab" onclick="showTab('binary')">
                üî¢ Vue Binaire
            </button>
            <button class="nav-tab" onclick="showTab('calculation')">
                üßÆ Calcul D√©taill√©
            </button>
            <button class="nav-tab" onclick="showTab('results')">
                üìä R√©sultats
            </button>
            <button class="nav-tab" onclick="showTab('export')">
                üíæ Export
            </button>
        </nav>

        <!-- Section Configuration -->
        <section id="config" class="tab-content active">
            <h2>‚öôÔ∏è Configuration du R√©seau</h2>
            
            <div class="form-grid">
                <div class="input-group">
                    <label for="network">
                        üåê Adresse R√©seau
                        <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltip-text">Adresse IP du r√©seau principal en notation d√©cimale (ex: 192.168.0.0)</span>
                        </span>
                    </label>
                    <input type="text" id="network" placeholder="192.168.0.0" value="192.168.0.0">
                </div>

                <div class="input-group">
                    <label for="mask">
                        üé≠ Masque CIDR
                        <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltip-text">Masque de sous-r√©seau en notation CIDR (ex: /24 pour 255.255.255.0)</span>
                        </span>
                    </label>
                    <input type="text" id="mask" placeholder="/24" value="/22">
                </div>

                <div class="input-group">
                    <label for="subnetCount">
                        üè¢ Nombre de Sous-r√©seaux
                        <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltip-text">Nombre de sous-r√©seaux n√©cessaires pour votre organisation</span>
                        </span>
                    </label>
                    <input type="number" id="subnetCount" min="1" max="8" value="4">
                </div>
            </div>

            <div id="departmentInputs"></div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="generateDepartmentInputs()">
                    üöÄ G√©n√©rer les D√©partements
                </button>
                <button class="btn btn-secondary" onclick="loadExample()">
                    üìã Exemple Complet
                </button>
                <button class="btn btn-secondary" onclick="calculateVLSM()">
                    üßÆ Calculer VLSM
                </button>
            </div>
        </section>

        <!-- Section Vue Binaire -->
        <section id="binary" class="tab-content">
            <h2>üî¢ Vue Binaire D√©taill√©e</h2>
            
            <div class="binary-explanation">
                <div class="binary-header">
                    <h3>üéØ Comprendre l'Adressage IP en Binaire</h3>
                    <p>Visualisez comment les bits sont r√©partis entre r√©seau, sous-r√©seau et h√¥te</p>
                </div>

                <div class="binary-visualization">
                    <h4>üåê R√©seau Principal</h4>
                    <div id="mainNetworkBinary"></div>
                    
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--network-bit);"></div>
                            <span>Bits R√©seau (Fix√©s)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--subnet-bit);"></div>
                            <span>Bits Sous-r√©seau (Emprunt√©s)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--host-bit);"></div>
                            <span>Bits H√¥te (Restants)</span>
                        </div>
                    </div>
                </div>

                <div id="subnetBinaryDetails"></div>
            </div>

            <div class="ip-address-breakdown" id="ipBreakdown"></div>
        </section>

        <!-- Section Calcul D√©taill√© -->
        <section id="calculation" class="tab-content">
            <h2>üßÆ Calcul VLSM Pas √† Pas</h2>
            
            <div class="calculation-steps" id="calculationSteps"></div>

            <div class="subnet-comparison" id="subnetComparison"></div>
        </section>

        <!-- Section R√©sultats -->
        <section id="results" class="tab-content">
            <h2>üìä R√©sultats du VLSM</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="totalHosts">0</span>
                    <span class="stat-label">H√¥tes Demand√©s</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="totalAllocated">0</span>
                    <span class="stat-label">H√¥tes Allou√©s</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="efficiency">0%</span>
                    <span class="stat-label">Efficacit√©</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="savings">0</span>
                    <span class="stat-label">Adresses Sauvegard√©es</span>
                </div>
            </div>

            <div class="progress-container">
                <div id="utilizationBar" class="progress-bar" style="width: 0%"></div>
            </div>
            <div class="text-center" id="utilizationText">Utilisation: 0%</div>

            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>D√©partement</th>
                            <th>R√©seau</th>
                            <th>Masque</th>
                            <th>H√¥tes Max</th>
                            <th>Premi√®re IP</th>
                            <th>Derni√®re IP</th>
                            <th>Broadcast</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>
            </div>
        </section>

        <!-- Section Export -->
        <section id="export" class="tab-content">
            <h2>üíæ Export des R√©sultats</h2>
            
            <div class="subnet-comparison" id="exportCards"></div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="exportToExcel()">
                    üìä Exporter Excel
                </button>
                <button class="btn btn-primary" onclick="exportToPDF()">
                    üìÑ Exporter PDF
                </button>
                <button class="btn btn-secondary" onclick="showTab('results')">
                    ‚¨ÖÔ∏è Retour aux R√©sultats
                </button>
            </div>
        </section>
    </div>

    <script>
        // √âtat global de l'application
        const AppState = {
            departments: [],
            results: [],
            network: '192.168.0.0',
            mask: '/22',
            
            init() {
                this.loadFromStorage();
                this.setupEventListeners();
            },
            
            setupEventListeners() {
                // Sauvegarde automatique
                document.querySelectorAll('input, select').forEach(input => {
                    input.addEventListener('change', () => this.saveToStorage());
                });
            },
            
            saveToStorage() {
                const state = {
                    network: document.getElementById('network').value,
                    mask: document.getElementById('mask').value,
                    subnetCount: document.getElementById('subnetCount').value,
                    departments: this.departments
                };
                localStorage.setItem('vlsm-binary-calculator', JSON.stringify(state));
            },
            
            loadFromStorage() {
                const saved = localStorage.getItem('vlsm-binary-calculator');
                if (saved) {
                    const state = JSON.parse(saved);
                    document.getElementById('network').value = state.network || '192.168.0.0';
                    document.getElementById('mask').value = state.mask || '/22';
                    document.getElementById('subnetCount').value = state.subnetCount || 4;
                    this.departments = state.departments || [];
                    
                    if (this.departments.length > 0) {
                        this.generateDepartmentInputs();
                    }
                }
            },
            
            clear() {
                this.departments = [];
                this.results = [];
                localStorage.removeItem('vlsm-binary-calculator');
            }
        };

        // Templates de d√©partements
        const DepartmentTemplates = {
            administration: { name: "Administration", hosts: 50, color: "#2E7D32" },
            production: { name: "Production", hosts: 120, color: "#1565C0" },
            commercial: { name: "Commercial", hosts: 30, color: "#FF6D00" },
            recherche: { name: "R&D", hosts: 25, color: "#6A1B9A" },
            direction: { name: "Direction", hosts: 10, color: "#C62828" },
            informatique: { name: "Informatique", hosts: 20, color: "#00838F" },
            marketing: { name: "Marketing", hosts: 15, color: "#EF6C00" },
            rh: { name: "Ressources Humaines", hosts: 18, color: "#7B1FA2" }
        };

        // Fonctions principales
        function showTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        function generateDepartmentInputs() {
            const subnetCount = parseInt(document.getElementById('subnetCount').value);
            const container = document.getElementById('departmentInputs');
            
            if (isNaN(subnetCount) || subnetCount < 1) {
                alert('Veuillez entrer un nombre valide de sous-r√©seaux');
                return;
            }
            
            let html = '<h3>üè¢ Configuration des D√©partements</h3><div class="form-grid">';
            const templateKeys = Object.keys(DepartmentTemplates);
            
            for (let i = 0; i < subnetCount; i++) {
                const template = DepartmentTemplates[templateKeys[i % templateKeys.length]];
                
                html += `
                    <div class="input-group">
                        <label>D√©partement ${i + 1}</label>
                        <input type="text" 
                               value="${template.name}" 
                               onchange="updateDepartment(${i}, 'name', this.value)"
                               placeholder="Nom du d√©partement">
                        <input type="number" 
                               value="${template.hosts}" 
                               onchange="updateDepartment(${i}, 'hosts', parseInt(this.value))"
                               min="1" 
                               placeholder="Nombre d'h√¥tes">
                        <select onchange="applyTemplate(${i}, this.value)">
                            <option value="">Choisir un mod√®le</option>
                            ${Object.keys(DepartmentTemplates).map(key => 
                                `<option value="${key}" ${key === templateKeys[i % templateKeys.length] ? 'selected' : ''}>
                                    ${DepartmentTemplates[key].name} (${DepartmentTemplates[key].hosts} h√¥tes)
                                </option>`
                            ).join('')}
                        </select>
                    </div>
                `;
                
                if (!AppState.departments[i]) {
                    AppState.departments[i] = { ...template };
                }
            }
            
            html += '</div>';
            container.innerHTML = html;
            AppState.saveToStorage();
        }

        function updateDepartment(index, field, value) {
            if (AppState.departments[index]) {
                AppState.departments[index][field] = value;
                AppState.saveToStorage();
            }
        }

        function applyTemplate(index, templateKey) {
            if (DepartmentTemplates[templateKey]) {
                AppState.departments[index] = { ...DepartmentTemplates[templateKey] };
                generateDepartmentInputs();
            }
        }

        // Fonctions de conversion
        function ipToInt(ip) {
            return ip.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet), 0) >>> 0;
        }

        function intToIp(int) {
            return [(int >>> 24) & 255, (int >>> 16) & 255, (int >>> 8) & 255, int & 255].join('.');
        }

        function ipToBinary(ip) {
            return ip.split('.').map(octet => 
                parseInt(octet).toString(2).padStart(8, '0')
            ).join('');
        }

        function binaryToIp(binary) {
            const octets = [];
            for (let i = 0; i < 32; i += 8) {
                octets.push(parseInt(binary.substr(i, 8), 2));
            }
            return octets.join('.');
        }

        function maskToPrefix(mask) {
            if (mask.startsWith('/')) {
                return parseInt(mask.slice(1));
            }
            const parts = mask.split('.').map(Number);
            const binary = parts.map(part => part.toString(2).padStart(8, '0')).join('');
            return binary.indexOf('0');
        }

        function prefixToMask(prefix) {
            let mask = '';
            for (let i = 0; i < 32; i++) {
                mask += i < prefix ? '1' : '0';
            }
            return binaryToIp(mask);
        }

        // Fonctions de visualisation binaire
        function createBinaryVisualization(binary, prefix, subnetBits = 0) {
            let html = '<div class="bits-container">';
            
            for (let i = 0; i < 32; i++) {
                let bitClass = 'bit';
                const bitValue = binary[i];
                
                if (i < prefix) {
                    bitClass += ' bit-network';
                } else if (i < prefix + subnetBits) {
                    bitClass += ' bit-subnet';
                } else {
                    bitClass += ' bit-host';
                }
                
                if (bitValue === '1') {
                    bitClass += ' bit-1';
                } else {
                    bitClass += ' bit-0';
                }
                
                html += `<div class="${bitClass}" title="Bit ${i}: ${getBitDescription(i, prefix, subnetBits)}">${bitValue}</div>`;
                
                // Ajouter un s√©parateur tous les 8 bits
                if ((i + 1) % 8 === 0 && i < 31) {
                    html += '<div class="bit-separator">.</div>';
                }
            }
            
            html += '</div>';
            return html;
        }

        function getBitDescription(bitIndex, prefix, subnetBits) {
            if (bitIndex < prefix) {
                return `Bit r√©seau #${bitIndex + 1} - Partie fixe de l'adresse`;
            } else if (bitIndex < prefix + subnetBits) {
                return `Bit sous-r√©seau #${bitIndex - prefix + 1} - Identifie le sous-r√©seau`;
            } else {
                return `Bit h√¥te #${bitIndex - prefix - subnetBits + 1} - Identifie l'h√¥te dans le sous-r√©seau`;
            }
        }

        function calculateVLSM() {
            const network = document.getElementById('network').value;
            const mask = document.getElementById('mask').value;
            
            if (!network || !mask || AppState.departments.length === 0) {
                alert('Veuillez compl√©ter la configuration');
                return;
            }
            
            const prefix = maskToPrefix(mask);
            const networkInt = ipToInt(network);
            const totalSize = Math.pow(2, 32 - prefix);
            
            // Trier par nombre d'h√¥tes d√©croissant
            const sortedDepartments = [...AppState.departments].sort((a, b) => b.hosts - a.hosts);
            
            let currentAddress = networkInt;
            AppState.results = [];
            let totalRequested = 0;
            let totalAllocated = 0;
            
            for (let i = 0; i < sortedDepartments.length; i++) {
                const dept = sortedDepartments[i];
                const neededAddresses = dept.hosts + 2;
                const newPrefix = 32 - Math.ceil(Math.log2(neededAddresses));
                const subnetSize = Math.pow(2, 32 - newPrefix);
                const subnetBits = newPrefix - prefix;
                
                const networkAddr = currentAddress;
                const firstUsable = networkAddr + 1;
                const lastUsable = networkAddr + subnetSize - 2;
                const broadcastAddr = networkAddr + subnetSize - 1;
                
                AppState.results.push({
                    name: dept.name,
                    network: intToIp(networkAddr),
                    prefix: newPrefix,
                    hosts: subnetSize - 2,
                    firstIP: intToIp(firstUsable),
                    lastIP: intToIp(lastUsable),
                    broadcast: intToIp(broadcastAddr),
                    color: dept.color,
                    requested: dept.hosts,
                    subnetBits: subnetBits,
                    hostBits: 32 - newPrefix
                });
                
                totalRequested += dept.hosts;
                totalAllocated += subnetSize - 2;
                currentAddress += subnetSize;
            }
            
            // Trier par ordre original
            AppState.results.sort((a, b) => {
                const indexA = AppState.departments.findIndex(dept => dept.name === a.name);
                const indexB = AppState.departments.findIndex(dept => dept.name === b.name);
                return indexA - indexB;
            });
            
            displayResults(totalRequested, totalAllocated);
            showTab('results');
        }

        function displayResults(totalRequested, totalAllocated) {
            // Statistiques
            document.getElementById('totalHosts').textContent = totalRequested;
            document.getElementById('totalAllocated').textContent = totalAllocated;
            
            const efficiency = Math.round((totalRequested / totalAllocated) * 100);
            document.getElementById('efficiency').textContent = efficiency + '%';
            document.getElementById('savings').textContent = totalAllocated - totalRequested;
            
            // Barre de progression
            document.getElementById('utilizationBar').style.width = efficiency + '%';
            document.getElementById('utilizationText').textContent = 
                `Utilisation: ${efficiency}% (${totalRequested}/${totalAllocated} h√¥tes)`;
            
            // Tableau des r√©sultats
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = AppState.results.map(result => `
                <tr style="border-left: 4px solid ${result.color}">
                    <td><strong>${result.name}</strong></td>
                    <td>${result.network}</td>
                    <td>/${result.prefix}</td>
                    <td>${result.hosts}</td>
                    <td>${result.firstIP}</td>
                    <td>${result.lastIP}</td>
                    <td>${result.broadcast}</td>
                </tr>
            `).join('');
            
            // Mettre √† jour les visualisations
            updateBinaryVisualizations();
            updateCalculationSteps();
            updateExportCards();
        }

        function updateBinaryVisualizations() {
            const network = document.getElementById('network').value;
            const prefix = maskToPrefix(document.getElementById('mask').value);
            const binaryNetwork = ipToBinary(network);
            
            // R√©seau principal
            document.getElementById('mainNetworkBinary').innerHTML = `
                <div class="step-content">
                    <strong>Adresse r√©seau:</strong> ${network}/${prefix}<br>
                    <strong>Binaire:</strong> ${binaryNetwork.match(/.{1,8}/g).join('.')}
                </div>
                ${createBinaryVisualization(binaryNetwork, prefix)}
                <div class="step-content">
                    <strong>Bits r√©seau:</strong> ${prefix} | 
                    <strong>Bits h√¥te disponibles:</strong> ${32 - prefix} | 
                    <strong>Adresses totales:</strong> 2<sup>${32 - prefix}</sup> = ${Math.pow(2, 32 - prefix)}
                </div>
            `;
            
            // D√©tails des sous-r√©seaux
            let subnetHtml = '<h4>üîß Sous-r√©seaux VLSM</h4>';
            AppState.results.forEach((result, index) => {
                const binarySubnet = ipToBinary(result.network);
                subnetHtml += `
                    <div class="calculation-step">
                        <div class="step-title">${result.name} - ${result.network}/${result.prefix}</div>
                        ${createBinaryVisualization(binarySubnet, maskToPrefix(document.getElementById('mask').value), result.subnetBits)}
                        <div class="step-content">
                            <strong>Structure:</strong><br>
                            ‚Ä¢ Bits r√©seau: ${maskToPrefix(document.getElementById('mask').value)}<br>
                            ‚Ä¢ Bits sous-r√©seau: ${result.subnetBits}<br>
                            ‚Ä¢ Bits h√¥te: ${result.hostBits}<br>
                            ‚Ä¢ Taille: 2<sup>${result.hostBits}</sup> = ${Math.pow(2, result.hostBits)} adresses
                        </div>
                    </div>
                `;
            });
            document.getElementById('subnetBinaryDetails').innerHTML = subnetHtml;
            
            // Breakdown IP
            const ipBreakdown = document.getElementById('ipBreakdown');
            ipBreakdown.innerHTML = network.split('.').map((octet, index) => `
                <div class="ip-octet">
                    <div class="octet-value">${octet}</div>
                    <div class="octet-binary">${parseInt(octet).toString(2).padStart(8, '0')}</div>
                    <div>Octet ${index + 1}</div>
                </div>
            `).join('');
        }

        function updateCalculationSteps() {
            const stepsContainer = document.getElementById('calculationSteps');
            let stepsHtml = '';
            
            stepsHtml += `
                <div class="calculation-step">
                    <div class="step-title">üìù √âtape 1: Analyse du R√©seau Principal</div>
                    <div class="step-content">
                        R√©seau: ${document.getElementById('network').value}${document.getElementById('mask').value}<br>
                        Bits r√©seau: ${maskToPrefix(document.getElementById('mask').value)}<br>
                        Bits h√¥te initiaux: ${32 - maskToPrefix(document.getElementById('mask').value)}<br>
                        Adresses disponibles: 2<sup>${32 - maskToPrefix(document.getElementById('mask').value)}</sup> = ${Math.pow(2, 32 - maskToPrefix(document.getElementById('mask').value))}
                    </div>
                </div>
            `;
            
            AppState.results.forEach((result, index) => {
                stepsHtml += `
                    <div class="calculation-step">
                        <div class="step-title">üîß √âtape ${index + 2}: ${result.name}</div>
                        <div class="step-content">
                            H√¥tes demand√©s: ${result.requested}<br>
                            Adresses n√©cessaires: ${result.requested} + 2 = ${result.requested + 2}<br>
                            Nouveau pr√©fixe: 32 - ‚åàlog‚ÇÇ(${result.requested + 2})‚åâ = /${result.prefix}<br>
                            Bits emprunt√©s: ${result.prefix} - ${maskToPrefix(document.getElementById('mask').value)} = ${result.subnetBits}<br>
                            Bits h√¥te restants: ${result.hostBits}<br>
                            Taille du sous-r√©seau: 2<sup>${result.hostBits}</sup> = ${Math.pow(2, result.hostBits)} adresses
                        </div>
                    </div>
                `;
            });
            
            stepsContainer.innerHTML = stepsHtml;
            
            // Comparaison des sous-r√©seaux
            const comparisonContainer = document.getElementById('subnetComparison');
            comparisonContainer.innerHTML = AppState.results.map(result => `
                <div class="subnet-card" style="border-top-color: ${result.color}">
                    <h4>${result.name}</h4>
                    <div class="step-content">
                        <strong>${result.network}/${result.prefix}</strong><br>
                        H√¥tes: ${result.requested}/${result.hosts}<br>
                        Masque: ${prefixToMask(result.prefix)}<br>
                        Plage: ${result.firstIP} - ${result.lastIP}<br>
                        Broadcast: ${result.broadcast}
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${(result.requested / result.hosts) * 100}%"></div>
                    </div>
                    <div>Utilisation: ${Math.round((result.requested / result.hosts) * 100)}%</div>
                </div>
            `).join('');
        }

        function updateExportCards() {
            const exportCards = document.getElementById('exportCards');
            exportCards.innerHTML = AppState.results.map(result => `
                <div class="subnet-card" style="border-top-color: ${result.color}">
                    <h4>${result.name}</h4>
                    <div class="step-content">
                        <strong>Configuration compl√®te:</strong><br><br>
                        <strong>Adresse r√©seau:</strong> ${result.network}<br>
                        <strong>Masque:</strong> ${prefixToMask(result.prefix)} (/${result.prefix})<br>
                        <strong>Gateway:</strong> ${result.firstIP}<br>
                        <strong>Plage utilisable:</strong> ${result.firstIP} - ${result.lastIP}<br>
                        <strong>Broadcast:</strong> ${result.broadcast}<br><br>
                        <strong>Configuration routeur:</strong><br>
                        <code>interface vlan${AppState.results.indexOf(result) + 10}<br>
                        ip address ${result.firstIP} ${result.prefix}</code>
                    </div>
                </div>
            `).join('');
        }

        // Fonctions d'export
        function exportToExcel() {
            if (AppState.results.length === 0) {
                alert('Aucun r√©sultat √† exporter');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['D√©partement', 'R√©seau', 'Masque', 'H√¥tes Max', 'H√¥tes Demand√©s', 'Premi√®re IP', 'Derni√®re IP', 'Broadcast', 'Efficacit√©']
            ];
            
            AppState.results.forEach(result => {
                const efficiency = Math.round((result.requested / result.hosts) * 100);
                wsData.push([
                    result.name,
                    result.network,
                    `/${result.prefix}`,
                    result.hosts,
                    result.requested,
                    result.firstIP,
                    result.lastIP,
                    result.broadcast,
                    `${efficiency}%`
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'Plan VLSM D√©taill√©');
            XLSX.writeFile(wb, 'plan_vlsm_detaille.xlsx');
        }

        function exportToPDF() {
            if (AppState.results.length === 0) {
                alert('Aucun r√©sultat √† exporter');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // En-t√™te
            doc.setFontSize(20);
            doc.text('Plan de R√©seau VLSM - Analyse Binaire', 20, 30);
            doc.setFontSize(12);
            doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}`, 20, 40);
            
            let y = 60;
            AppState.results.forEach((result, index) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFont(undefined, 'bold');
                doc.text(`${result.name} - ${result.network}/${result.prefix}`, 20, y);
                doc.setFont(undefined, 'normal');
                y += 10;
                
                doc.text(`Bits sous-r√©seau: ${result.subnetBits} | Bits h√¥te: ${result.hostBits}`, 25, y);
                y += 7;
                doc.text(`Plage IP: ${result.firstIP} - ${result.lastIP}`, 25, y);
                y += 7;
                doc.text(`Broadcast: ${result.broadcast}`, 25, y);
                y += 7;
                doc.text(`H√¥tes: ${result.requested}/${result.hosts} (${Math.round((result.requested / result.hosts) * 100)}%)`, 25, y);
                y += 15;
            });
            
            doc.save('analyse_vlsm_binaire.pdf');
        }

        // Fonctions utilitaires
        function loadExample() {
            document.getElementById('network').value = '192.168.0.0';
            document.getElementById('mask').value = '/22';
            document.getElementById('subnetCount').value = 4;
            generateDepartmentInputs();
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            AppState.init();
            
            // Charger un exemple au premier d√©marrage
            if (!localStorage.getItem('vlsm-binary-calculator')) {
                setTimeout(loadExample, 500);
            }
        });
    </script>
</body>
</html>
