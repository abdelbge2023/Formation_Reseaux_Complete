<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculateur VLSM Professionnel Complet</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
    --primary: #4CAF50;
    --secondary: #2196F3;
    --accent: #FF9800;
    --warning: #f44336;
    --success: #4CAF50;
    --dark: #333;
    --light: #f8f9fa;
    --border: #dee2e6;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    color: #333;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
}

/* Header */
header {
    background: linear-gradient(135deg, var(--primary) 0%, #45a049 100%);
    color: white;
    padding: 2rem 1rem;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}

header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="network" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="2" cy="2" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23network)"/></svg>');
}

header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    position: relative;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

header p {
    font-size: 1.1rem;
    opacity: 0.9;
    position: relative;
}

/* Navigation */
nav {
    background: var(--dark);
    padding: 1rem;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.nav-container {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    max-width: 1200px;
    margin: 0 auto;
}

nav button {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    padding: 0.75rem 1.5rem;
    color: white;
    cursor: pointer;
    border-radius: 25px;
    transition: all 0.3s ease;
    font-weight: 500;
}

nav button:hover {
    background: var(--primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

/* Main Content */
main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

section {
    background: white;
    margin: 2rem 0;
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    border: 1px solid var(--border);
}

section h2 {
    color: var(--dark);
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 3px solid var(--primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Form Styles */
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.input-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.input-group label {
    font-weight: 600;
    color: var(--dark);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.input-group input,
.input-group select,
.input-group textarea {
    padding: 0.75rem;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.input-group input:focus,
.input-group select:focus,
.input-group textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
}

/* Buttons */
.button-group {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin: 1.5rem 0;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: #45a049;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.btn-secondary {
    background: var(--secondary);
    color: white;
}

.btn-secondary:hover {
    background: #1976d2;
    transform: translateY(-2px);
}

.btn-outline {
    background: transparent;
    border: 2px solid var(--primary);
    color: var(--primary);
}

.btn-outline:hover {
    background: var(--primary);
    color: white;
}

/* Table Styles */
.table-responsive {
    overflow-x: auto;
    margin: 1.5rem 0;
}

table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

th, td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid var(--border);
}

th {
    background: var(--light);
    font-weight: 600;
    color: var(--dark);
}

tr:hover {
    background: #f8f9fa;
}

/* Network Visualization */
.network-visualization {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 15px;
    margin: 2rem 0;
}

.subnet-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.subnet-card {
    background: rgba(255,255,255,0.1);
    padding: 1.5rem;
    border-radius: 10px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
}

.subnet-card h4 {
    margin-bottom: 1rem;
    color: white;
}

/* Binary Visualization */
.binary-visualization {
    background: var(--light);
    padding: 1.5rem;
    border-radius: 10px;
    margin: 1rem 0;
}

.bits-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
    margin: 1rem 0;
}

.bit {
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 5px;
    font-weight: bold;
    font-size: 0.8rem;
}

.bit-network {
    background: var(--primary);
    color: white;
}

.bit-subnet {
    background: var(--secondary);
    color: white;
}

.bit-host {
    background: var(--accent);
    color: white;
}

/* Progress Bar */
.progress-container {
    background: var(--border);
    border-radius: 10px;
    height: 20px;
    margin: 1rem 0;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    transition: width 0.3s ease;
}

/* Alert Styles */
.alert {
    padding: 1rem;
    border-radius: 8px;
    margin: 1rem 0;
    border-left: 4px solid;
}

.alert-success {
    background: #d4edda;
    border-color: var(--success);
    color: #155724;
}

.alert-warning {
    background: #fff3cd;
    border-color: var(--warning);
    color: #856404;
}

.alert-info {
    background: #d1ecf1;
    border-color: var(--secondary);
    color: #0c5460;
}

/* Tooltip */
.tooltip {
    position: relative;
    display: inline-block;
}

.tooltip .tooltip-text {
    visibility: hidden;
    width: 200px;
    background: var(--dark);
    color: white;
    text-align: center;
    border-radius: 6px;
    padding: 0.5rem;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    transition: opacity 0.3s;
}

.tooltip:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
}

/* Responsive Design */
@media (max-width: 768px) {
    header h1 {
        font-size: 2rem;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .button-group {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
    
    nav button {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
    }
    
    section {
        padding: 1rem;
        margin: 1rem 0;
    }
}

/* Animation */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.fade-in {
    animation: fadeIn 0.5s ease-in;
}

/* Loading Spinner */
.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 2rem auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Print Styles */
@media print {
    nav, .button-group, .no-print {
        display: none;
    }
    
    section {
        box-shadow: none;
        border: 1px solid #000;
        break-inside: avoid;
    }
}

/* Utility Classes */
.text-center { text-align: center; }
.text-right { text-align: right; }
.mb-1 { margin-bottom: 1rem; }
.mb-2 { margin-bottom: 2rem; }
.mt-1 { margin-top: 1rem; }
.mt-2 { margin-top: 2rem; }
.hidden { display: none; }

/* Department Cards */
.department-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin: 1.5rem 0;
}

.department-card {
    background: white;
    border: 2px solid var(--border);
    border-radius: 10px;
    padding: 1.5rem;
    transition: all 0.3s ease;
}

.department-card:hover {
    border-color: var(--primary);
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
}

.department-card h4 {
    color: var(--dark);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.device-list {
    list-style: none;
    margin: 1rem 0;
}

.device-list li {
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: between;
    align-items: center;
}

.device-list li:last-child {
    border-bottom: none;
}

/* Color coding for devices */
.device-pc { color: var(--primary); }
.device-server { color: var(--secondary); }
.device-printer { color: var(--accent); }
.device-camera { color: #9C27B0; }
.device-phone { color: #E91E63; }

/* Statistics */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 1.5rem 0;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    text-align: center;
    border-left: 4px solid var(--primary);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary);
    display: block;
}

.stat-label {
    color: var(--dark);
    font-size: 0.9rem;
}
</style>
</head>
<body>
    <header>
        <h1>üåê Calculateur VLSM Professionnel</h1>
        <p>Optimisez votre plan d'adressage IP avec le sous-r√©seautage √† masque variable</p>
    </header>

    <nav>
        <div class="nav-container">
            <button onclick="showSection('configuration')">‚öôÔ∏è Configuration</button>
            <button onclick="showSection('departments')">üè¢ D√©partements</button>
            <button onclick="showSection('calculation')">üßÆ Calcul VLSM</button>
            <button onclick="showSection('results')">üìä R√©sultats</button>
            <button onclick="showSection('visualization')">üìà Visualisation</button>
            <button onclick="showSection('export')">üíæ Export</button>
            <footer>Version Web (El azhari Amazzale Abdelhadi)</footer>
        </div>
    </nav>

    <main>
        <!-- Section Configuration -->
        <section id="configuration" class="fade-in">
            <h2>‚öôÔ∏è Configuration du R√©seau</h2>
            
            <div class="alert alert-info">
                <strong>üí° Information :</strong> Le VLSM permet de cr√©er des sous-r√©seaux de tailles diff√©rentes 
                pour optimiser l'utilisation des adresses IP.
            </div>

            <div class="form-grid">
                <div class="input-group">
                    <label for="network">
                        üîß Adresse R√©seau
                        <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltip-text">Adresse IP du r√©seau principal (ex: 192.168.0.0)</span>
                        </span>
                    </label>
                    <input type="text" id="network" placeholder="192.168.0.0" value="192.168.0.0">
                </div>

                <div class="input-group">
                    <label for="mask">
                        üé≠ Masque de Sous-R√©seau
                        <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltip-text">Masque en notation CIDR ou d√©cimale (ex: /24 ou 255.255.255.0)</span>
                        </span>
                    </label>
                    <input type="text" id="mask" placeholder="/24" value="/22">
                </div>

                <div class="input-group">
                    <label for="subnetCount">
                        üè¢ Nombre de D√©partements
                        <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltip-text">Nombre de sous-r√©seaux n√©cessaires</span>
                        </span>
                    </label>
                    <input type="number" id="subnetCount" min="1" max="10" value="4">
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="generateDepartmentInputs()">
                    üöÄ G√©n√©rer les D√©partements
                </button>
                <button class="btn btn-outline" onclick="loadExample()">
                    üìã Charger un Exemple
                </button>
                <button class="btn btn-outline" onclick="clearForm()">
                    üóëÔ∏è Effacer Tout
                </button>
            </div>
        </section>

        <!-- Section D√©partements -->
        <section id="departments" class="hidden fade-in">
            <h2>üè¢ Configuration des D√©partements</h2>
            
            <div id="departmentInputs"></div>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="calculateVLSM()">
                    üßÆ Calculer le VLSM
                </button>
                <button class="btn btn-secondary" onclick="showSection('configuration')">
                    ‚¨ÖÔ∏è Retour
                </button>
            </div>
        </section>

        <!-- Section Calcul -->
        <section id="calculation" class="hidden fade-in">
            <h2>üßÆ Calcul en Cours</h2>
            <div class="text-center">
                <div class="spinner"></div>
                <p>Optimisation de votre plan d'adressage IP...</p>
            </div>
        </section>

        <!-- Section R√©sultats -->
        <section id="results" class="hidden fade-in">
            <h2>üìä R√©sultats du VLSM</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="totalHosts">0</span>
                    <span class="stat-label">H√¥tes Demand√©s</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="totalAllocated">0</span>
                    <span class="stat-label">H√¥tes Allou√©s</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="efficiency">0%</span>
                    <span class="stat-label">Efficacit√©</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="savings">0</span>
                    <span class="stat-label">Adresses Sauvegard√©es</span>
                </div>
            </div>

            <div class="table-responsive">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>D√©partement</th>
                            <th>R√©seau</th>
                            <th>Masque</th>
                            <th>H√¥tes Max</th>
                            <th>Premi√®re IP</th>
                            <th>Derni√®re IP</th>
                            <th>Broadcast</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="showSection('visualization')">
                    üìà Voir la Visualisation
                </button>
                <button class="btn btn-secondary" onclick="showSection('departments')">
                    ‚úèÔ∏è Modifier la Configuration
                </button>
            </div>
        </section>

        <!-- Section Visualisation -->
        <section id="visualization" class="hidden fade-in">
            <h2>üìà Visualisation du R√©seau</h2>
            
            <div class="network-visualization">
                <h3 style="color: white;">üåê R√©partition des Sous-r√©seaux</h3>
                <div id="subnetGrid" class="subnet-grid"></div>
            </div>

            <div class="binary-visualization">
                <h3>üî¢ Repr√©sentation Binaire</h3>
                <div id="binaryDisplay"></div>
            </div>

            <div class="progress-container">
                <div id="utilizationBar" class="progress-bar" style="width: 0%"></div>
            </div>
            <div class="text-center" id="utilizationText">Utilisation: 0%</div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="showSection('export')">
                    üíæ Exporter les R√©sultats
                </button>
                <button class="btn btn-secondary" onclick="showSection('results')">
                    ‚¨ÖÔ∏è Retour aux R√©sultats
                </button>
            </div>
        </section>

        <!-- Section Export -->
        <section id="export" class="hidden fade-in">
            <h2>üíæ Export des R√©sultats</h2>
            
            <div class="department-cards" id="exportCards"></div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="exportToExcel()">
                    üìä Exporter Excel
                </button>
                <button class="btn btn-primary" onclick="exportToPDF()">
                    üìÑ Exporter PDF
                </button>
                <button class="btn btn-secondary" onclick="showSection('visualization')">
                    ‚¨ÖÔ∏è Retour
                </button>
            </div>
        </section>
    </main>

    <script>
        // √âtat global de l'application
        const AppState = {
            departments: [],
            results: [],
            currentSection: 'configuration',
            
            init() {
                this.loadFromStorage();
                this.setupEventListeners();
                this.showSection('configuration');
            },
            
            setupEventListeners() {
                // Sauvegarde automatique lors de la modification des inputs
                document.querySelectorAll('input, select, textarea').forEach(input => {
                    input.addEventListener('change', () => this.saveToStorage());
                });
            },
            
            saveToStorage() {
                const state = {
                    network: document.getElementById('network').value,
                    mask: document.getElementById('mask').value,
                    subnetCount: document.getElementById('subnetCount').value,
                    departments: this.departments
                };
                localStorage.setItem('vlsm-calculator', JSON.stringify(state));
            },
            
            loadFromStorage() {
                const saved = localStorage.getItem('vlsm-calculator');
                if (saved) {
                    const state = JSON.parse(saved);
                    document.getElementById('network').value = state.network || '192.168.0.0';
                    document.getElementById('mask').value = state.mask || '/22';
                    document.getElementById('subnetCount').value = state.subnetCount || 4;
                    this.departments = state.departments || [];
                    
                    if (this.departments.length > 0) {
                        this.generateDepartmentInputs();
                    }
                }
            },
            
            addDepartment(department) {
                this.departments.push(department);
                this.saveToStorage();
            },
            
            updateDepartment(index, field, value) {
                if (this.departments[index]) {
                    this.departments[index][field] = value;
                    this.saveToStorage();
                }
            },
            
            clear() {
                this.departments = [];
                this.results = [];
                localStorage.removeItem('vlsm-calculator');
            }
        };

        // Templates de d√©partements pr√©d√©finis
        const DepartmentTemplates = {
            administration: {
                name: "Administration",
                description: "Services administratifs et gestion",
                hosts: 50,
                devices: [
                    { type: 'pc', count: 35, name: 'Ordinateurs de bureau' },
                    { type: 'printer', count: 8, name: 'Imprimantes' },
                    { type: 'server', count: 5, name: 'Serveurs' },
                    { type: 'phone', count: 2, name: 'T√©l√©phones IP' }
                ],
                color: '#4CAF50'
            },
            production: {
                name: "Production",
                description: "Atelier et ligne de production",
                hosts: 120,
                devices: [
                    { type: 'pc', count: 80, name: 'Postes de production' },
                    { type: 'printer', count: 15, name: 'Imprimantes √©tiquettes' },
                    { type: 'camera', count: 20, name: 'Cam√©ras de surveillance' },
                    { type: 'server', count: 5, name: 'Serveurs industriels' }
                ],
                color: '#2196F3'
            },
            commercial: {
                name: "Commercial",
                description: "√âquipe commerciale et marketing",
                hosts: 30,
                devices: [
                    { type: 'pc', count: 20, name: 'Ordinateurs portables' },
                    { type: 'printer', count: 3, name: 'Imprimantes' },
                    { type: 'phone', count: 5, name: 'T√©l√©phones' },
                    { type: 'server', count: 2, name: 'Serveurs CRM' }
                ],
                color: '#FF9800'
            },
            recherche: {
                name: "Recherche & D√©veloppement",
                description: "Laboratoire et innovation",
                hosts: 25,
                devices: [
                    { type: 'pc', count: 15, name: 'Stations de travail' },
                    { type: 'server', count: 8, name: 'Serveurs de calcul' },
                    { type: 'printer', count: 2, name: 'Imprimantes techniques' }
                ],
                color: '#9C27B0'
            }
        };

        // Fonctions principales
        function showSection(sectionId) {
            // Masquer toutes les sections
            document.querySelectorAll('section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Afficher la section demand√©e
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                targetSection.classList.add('fade-in');
                AppState.currentSection = sectionId;
                
                // Animation sp√©ciale pour la section calcul
                if (sectionId === 'calculation') {
                    setTimeout(() => {
                        calculateVLSM();
                        showSection('results');
                    }, 2000);
                }
            }
        }

        function generateDepartmentInputs() {
            const subnetCount = parseInt(document.getElementById('subnetCount').value);
            const container = document.getElementById('departmentInputs');
            
            if (isNaN(subnetCount) || subnetCount < 1) {
                alert('Veuillez entrer un nombre valide de d√©partements');
                return;
            }
            
            let html = '';
            const templateKeys = Object.keys(DepartmentTemplates);
            
            for (let i = 0; i < subnetCount; i++) {
                const template = DepartmentTemplates[templateKeys[i % templateKeys.length]];
                
                html += `
                    <div class="department-card">
                        <h4>üè¢ D√©partement ${i + 1}</h4>
                        
                        <div class="input-group">
                            <label>Nom du D√©partement</label>
                            <input type="text" 
                                   value="${template.name}" 
                                   onchange="updateDepartment(${i}, 'name', this.value)"
                                   placeholder="Nom du d√©partement">
                        </div>
                        
                        <div class="input-group">
                            <label>Description</label>
                            <textarea onchange="updateDepartment(${i}, 'description', this.value)" 
                                      placeholder="Description du d√©partement">${template.description}</textarea>
                        </div>
                        
                        <div class="input-group">
                            <label>Nombre d'H√¥tes Requis</label>
                            <input type="number" 
                                   value="${template.hosts}" 
                                   onchange="updateDepartment(${i}, 'hosts', parseInt(this.value))"
                                   min="1">
                        </div>
                        
                        <div class="input-group">
                            <label>Mod√®le</label>
                            <select onchange="applyTemplate(${i}, this.value)">
                                <option value="custom">Personnalis√©</option>
                                ${Object.keys(DepartmentTemplates).map(key => 
                                    `<option value="${key}" ${key === templateKeys[i % templateKeys.length] ? 'selected' : ''}>
                                        ${DepartmentTemplates[key].name}
                                    </option>`
                                ).join('')}
                            </select>
                        </div>
                        
                        <div class="device-list">
                            <strong>üñ•Ô∏è Appareils :</strong>
                            ${template.devices.map(device => `
                                <li>
                                    <span class="device-${device.type}">${getDeviceIcon(device.type)}</span>
                                    <span>${device.count}x ${device.name}</span>
                                </li>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                // Initialiser le d√©partement dans l'√©tat
                if (!AppState.departments[i]) {
                    AppState.departments[i] = { ...template };
                }
            }
            
            container.innerHTML = html;
            showSection('departments');
        }

        function updateDepartment(index, field, value) {
            AppState.updateDepartment(index, field, value);
        }

        function applyTemplate(index, templateKey) {
            if (DepartmentTemplates[templateKey]) {
                AppState.departments[index] = { ...DepartmentTemplates[templateKey] };
                generateDepartmentInputs(); // Reg√©n√©rer pour mettre √† jour l'affichage
            }
        }

        function getDeviceIcon(type) {
            const icons = {
                pc: 'üíª',
                server: 'üñ•Ô∏è',
                printer: 'üñ®Ô∏è',
                camera: 'üìπ',
                phone: 'üì±'
            };
            return icons[type] || 'üì±';
        }

        // Fonctions de calcul VLSM
        function ipToInt(ip) {
            return ip.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet), 0) >>> 0;
        }

        function intToIp(int) {
            return [(int >>> 24) & 255, (int >>> 16) & 255, (int >>> 8) & 255, int & 255].join('.');
        }

        function maskToPrefix(mask) {
            if (mask.startsWith('/')) {
                return parseInt(mask.slice(1));
            }
            
            const parts = mask.split('.').map(Number);
            const binary = parts.map(part => part.toString(2).padStart(8, '0')).join('');
            return binary.indexOf('0');
        }

        function calculateVLSM() {
            const network = document.getElementById('network').value;
            const mask = document.getElementById('mask').value;
            
            if (!network || !mask) {
                alert('Veuillez remplir tous les champs de configuration');
                return;
            }
            
            const prefix = maskToPrefix(mask);
            const networkInt = ipToInt(network);
            const totalSize = Math.pow(2, 32 - prefix);
            
            // Trier les d√©partements par nombre d'h√¥tes d√©croissant
            const sortedDepartments = [...AppState.departments].sort((a, b) => b.hosts - a.hosts);
            
            let currentAddress = networkInt;
            AppState.results = [];
            let totalRequested = 0;
            let totalAllocated = 0;
            
            for (let i = 0; i < sortedDepartments.length; i++) {
                const dept = sortedDepartments[i];
                const neededAddresses = dept.hosts + 2; // +2 pour r√©seau et broadcast
                const newPrefix = 32 - Math.ceil(Math.log2(neededAddresses));
                const subnetSize = Math.pow(2, 32 - newPrefix);
                
                const networkAddr = currentAddress;
                const firstUsable = networkAddr + 1;
                const lastUsable = networkAddr + subnetSize - 2;
                const broadcastAddr = networkAddr + subnetSize - 1;
                
                AppState.results.push({
                    name: dept.name,
                    network: intToIp(networkAddr),
                    prefix: newPrefix,
                    hosts: subnetSize - 2,
                    firstIP: intToIp(firstUsable),
                    lastIP: intToIp(lastUsable),
                    broadcast: intToIp(broadcastAddr),
                    color: dept.color,
                    requested: dept.hosts
                });
                
                totalRequested += dept.hosts;
                totalAllocated += subnetSize - 2;
                currentAddress += subnetSize;
            }
            
            // Trier les r√©sultats par ordre original
            AppState.results.sort((a, b) => {
                const indexA = AppState.departments.findIndex(dept => dept.name === a.name);
                const indexB = AppState.departments.findIndex(dept => dept.name === b.name);
                return indexA - indexB;
            });
            
            displayResults(totalRequested, totalAllocated);
        }

        function displayResults(totalRequested, totalAllocated) {
            // Mettre √† jour les statistiques
            document.getElementById('totalHosts').textContent = totalRequested;
            document.getElementById('totalAllocated').textContent = totalAllocated;
            
            const efficiency = Math.round((totalRequested / totalAllocated) * 100);
            document.getElementById('efficiency').textContent = efficiency + '%';
            document.getElementById('savings').textContent = totalAllocated - totalRequested;
            
            // Mettre √† jour le tableau
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = AppState.results.map(result => `
                <tr style="border-left: 4px solid ${result.color}">
                    <td><strong>${result.name}</strong></td>
                    <td>${result.network}</td>
                    <td>/${result.prefix}</td>
                    <td>${result.hosts}</td>
                    <td>${result.firstIP}</td>
                    <td>${result.lastIP}</td>
                    <td>${result.broadcast}</td>
                </tr>
            `).join('');
            
            // Mettre √† jour la visualisation
            updateVisualization();
            updateExportCards();
        }

        function updateVisualization() {
            // Mettre √† jour la grille des sous-r√©seaux
            const subnetGrid = document.getElementById('subnetGrid');
            subnetGrid.innerHTML = AppState.results.map(result => `
                <div class="subnet-card" style="border-left: 4px solid ${result.color}">
                    <h4>${result.name}</h4>
                    <p><strong>R√©seau:</strong> ${result.network}/${result.prefix}</p>
                    <p><strong>H√¥tes:</strong> ${result.requested}/${result.hosts}</p>
                    <p><strong>Plage:</strong> ${result.firstIP} - ${result.lastIP}</p>
                </div>
            `).join('');
            
            // Mettre √† jour la barre de progression
            const totalAllocated = AppState.results.reduce((sum, r) => sum + r.hosts, 0);
            const totalRequested = AppState.results.reduce((sum, r) => sum + r.requested, 0);
            const utilization = (totalRequested / totalAllocated) * 100;
            
            document.getElementById('utilizationBar').style.width = utilization + '%';
            document.getElementById('utilizationText').textContent = 
                `Utilisation: ${Math.round(utilization)}% (${totalRequested}/${totalAllocated} h√¥tes)`;
            
            // Mettre √† jour la visualisation binaire
            updateBinaryVisualization();
        }

        function updateBinaryVisualization() {
            const binaryDisplay = document.getElementById('binaryDisplay');
            let html = '';
            
            AppState.results.forEach((result, index) => {
                const hostBits = 32 - result.prefix;
                html += `
                    <div class="mb-2">
                        <strong>${result.name} (/${result.prefix})</strong>
                        <div class="bits-container">
                            ${Array(32).fill(0).map((_, i) => {
                                let bitClass = 'bit';
                                if (i < result.prefix) {
                                    bitClass += ' bit-network';
                                } else if (i < result.prefix + 2) {
                                    bitClass += ' bit-subnet';
                                } else {
                                    bitClass += ' bit-host';
                                }
                                return `<div class="${bitClass}">${i < result.prefix ? '1' : '0'}</div>`;
                            }).join('')}
                        </div>
                        <small>Bits r√©seau: ${result.prefix} | Bits h√¥te: ${hostBits}</small>
                    </div>
                `;
            });
            
            binaryDisplay.innerHTML = html;
        }

        function updateExportCards() {
            const exportCards = document.getElementById('exportCards');
            exportCards.innerHTML = AppState.results.map(result => `
                <div class="department-card">
                    <h4>${result.name}</h4>
                    <p><strong>Configuration r√©seau:</strong></p>
                    <p>Adresse: ${result.network}/${result.prefix}</p>
                    <p>Gateway: ${result.firstIP}</p>
                    <p>Plage utilisable: ${result.firstIP} - ${result.lastIP}</p>
                    <p>Broadcast: ${result.broadcast}</p>
                    <p><strong>Configuration routeur:</strong></p>
                    <code>
                        interface vlan${AppState.results.indexOf(result) + 10}<br>
                        ip address ${result.firstIP} ${result.prefix}
                    </code>
                </div>
            `).join('');
        }

        // Fonctions d'export
        function exportToExcel() {
            if (AppState.results.length === 0) {
                alert('Aucun r√©sultat √† exporter');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['D√©partement', 'R√©seau', 'Masque', 'H√¥tes Max', 'H√¥tes Demand√©s', 'Premi√®re IP', 'Derni√®re IP', 'Broadcast']
            ];
            
            AppState.results.forEach(result => {
                wsData.push([
                    result.name,
                    result.network,
                    `/${result.prefix}`,
                    result.hosts,
                    result.requested,
                    result.firstIP,
                    result.lastIP,
                    result.broadcast
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'Plan VLSM');
            XLSX.writeFile(wb, 'plan_vlsm.xlsx');
        }

        function exportToPDF() {
            if (AppState.results.length === 0) {
                alert('Aucun r√©sultat √† exporter');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // En-t√™te
            doc.setFontSize(20);
            doc.text('Plan de R√©seau VLSM', 20, 30);
            doc.setFontSize(12);
            doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString()}`, 20, 40);
            
            let y = 60;
            AppState.results.forEach((result, index) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFont(undefined, 'bold');
                doc.text(result.name, 20, y);
                doc.setFont(undefined, 'normal');
                y += 10;
                
                doc.text(`R√©seau: ${result.network}/${result.prefix}`, 25, y);
                y += 7;
                doc.text(`H√¥tes: ${result.requested}/${result.hosts}`, 25, y);
                y += 7;
                doc.text(`Plage IP: ${result.firstIP} - ${result.lastIP}`, 25, y);
                y += 7;
                doc.text(`Gateway: ${result.firstIP}`, 25, y);
                y += 7;
                doc.text(`Broadcast: ${result.broadcast}`, 25, y);
                y += 15;
            });
            
            doc.save('plan_vlsm.pdf');
        }

        // Fonctions utilitaires
        function loadExample() {
            document.getElementById('network').value = '192.168.0.0';
            document.getElementById('mask').value = '/22';
            document.getElementById('subnetCount').value = 4;
            generateDepartmentInputs();
        }

        function clearForm() {
            if (confirm('√ätes-vous s√ªr de vouloir effacer toute la configuration ?')) {
                AppState.clear();
                document.getElementById('network').value = '';
                document.getElementById('mask').value = '';
                document.getElementById('subnetCount').value = '';
                document.getElementById('departmentInputs').innerHTML = '';
                document.getElementById('resultsBody').innerHTML = '';
                showSection('configuration');
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            AppState.init();
            
            // Charger un exemple au premier d√©marrage
            if (!localStorage.getItem('vlsm-calculator')) {
                setTimeout(loadExample, 1000);
            }
        });

        // Gestion des erreurs globales
        window.addEventListener('error', function(e) {
            console.error('Erreur:', e.error);
            alert('Une erreur est survenue. Veuillez recharger la page.');
        });
    </script>
</body>
</html>

